{% extends "base.html" %}

{% block title %}Search Senior Living Options | Radiant Retirement{% endblock %}

{% block description %}Search for senior living options by city, state, or facility across the United States.{% endblock %}

{% block content %}
<section class="search-hero">
    <div class="container">
        <h1>Search Senior Living Options</h1>
        
        <div class="search-container">
            <form action="/search.html" method="get" id="search-form">
                <input type="text" name="q" id="search-input" placeholder="Search for a city or facility..." value="{{ query }}" aria-label="Search for a city or facility">
                <button type="submit" class="search-button">
                    <span class="search-icon">&#x1F50D;</span>
                    <span class="sr-only">Search</span>
                </button>
            </form>
        </div>
        
        <div class="search-filters">
            <form id="filter-form">
                <div class="filter-group">
                    <label for="care-type">Care Type:</label>
                    <select id="care-type" name="type">
                        <option value="">All Types</option>
                        <option value="assisted-living" {% if care_type == 'assisted-living' %}selected{% endif %}>Assisted Living</option>
                        <option value="memory-care" {% if care_type == 'memory-care' %}selected{% endif %}>Memory Care</option>
                        <option value="independent-living" {% if care_type == 'independent-living' %}selected{% endif %}>Independent Living</option>
                        <option value="nursing-home" {% if care_type == 'nursing-home' %}selected{% endif %}>Nursing Home</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="state">State:</label>
                    <select id="state" name="state">
                        <option value="">All States</option>
                        {% for state_code, state_name in states.items() %}
                        <option value="{{ state_code }}" {% if state == state_code %}selected{% endif %}>{{ state_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="cost-range">Price Range:</label>
                    <select id="cost-range" name="cost">
                        <option value="">Any Price</option>
                        <option value="under-3000" {% if cost_range == 'under-3000' %}selected{% endif %}>Under $3,000/month</option>
                        <option value="3000-4000" {% if cost_range == '3000-4000' %}selected{% endif %}>$3,000 - $4,000/month</option>
                        <option value="4000-5000" {% if cost_range == '4000-5000' %}selected{% endif %}>$4,000 - $5,000/month</option>
                        <option value="5000-6000" {% if cost_range == '5000-6000' %}selected{% endif %}>$5,000 - $6,000/month</option>
                        <option value="over-6000" {% if cost_range == 'over-6000' %}selected{% endif %}>Over $6,000/month</option>
                    </select>
                </div>
                
                <button type="submit" class="filter-button">Apply Filters</button>
            </form>
        </div>
    </div>
</section>

<section class="search-results">
    <div class="container">
        <div class="results-meta">
            <h2>{{ results|length }} Results {% if query %}for "{{ query }}"{% endif %}</h2>
            {% if care_type or state or cost_range %}
            <div class="active-filters">
                <span>Active Filters:</span>
                <ul>
                    {% if care_type %}
                    <li>
                        {{ care_type|replace('-', ' ')|title }}
                        <a href="{{ remove_filter_url('type') }}" class="remove-filter" aria-label="Remove care type filter">✕</a>
                    </li>
                    {% endif %}
                    
                    {% if state %}
                    <li>
                        {{ states[state] }}
                        <a href="{{ remove_filter_url('state') }}" class="remove-filter" aria-label="Remove state filter">✕</a>
                    </li>
                    {% endif %}
                    
                    {% if cost_range %}
                    <li>
                        {% if cost_range == 'under-3000' %}
                            Under $3,000/month
                        {% elif cost_range == '3000-4000' %}
                            $3,000 - $4,000/month
                        {% elif cost_range == '4000-5000' %}
                            $4,000 - $5,000/month
                        {% elif cost_range == '5000-6000' %}
                            $5,000 - $6,000/month
                        {% elif cost_range == 'over-6000' %}
                            Over $6,000/month
                        {% endif %}
                        <a href="{{ remove_filter_url('cost') }}" class="remove-filter" aria-label="Remove cost filter">✕</a>
                    </li>
                    {% endif %}
                </ul>
                
                {% if care_type or state or cost_range %}
                <a href="/search.html{% if query %}?q={{ query }}{% endif %}" class="clear-all-filters">Clear All Filters</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <div class="results-container">
            <div class="result-tabs">
                <button class="tab-button active" data-tab="all">All Results</button>
                <button class="tab-button" data-tab="cities">Cities</button>
                <button class="tab-button" data-tab="facilities">Facilities</button>
            </div>
            
            <div class="tab-content" id="all">
                {% if results|length == 0 %}
                <div class="no-results">
                    <p>No results found for your search criteria.</p>
                    <p>Try adjusting your filters or search term.</p>
                </div>
                {% else %}
                    {% for result in results %}
                        {% if result.type == 'city' %}
                        <div class="result-card city-result">
                            <div class="result-content">
                                <h3 class="result-title">
                                    <a href="/city/{{ result.slug }}/">{{ result.name }}, {{ result.state }}</a>
                                </h3>
                                <div class="result-meta">
                                    <span class="result-type">City</span>
                                    <span class="result-population">Population: {{ "{:,}".format(result.population) }}</span>
                                </div>
                                <div class="result-details">
                                    <div class="result-costs">
                                        <span>Assisted Living: ${{ "{:,}".format(result.assisted_living_cost) }}/month</span>
                                        <span>Memory Care: ${{ "{:,}".format(result.memory_care_cost) }}/month</span>
                                    </div>
                                    <div class="result-facilities">
                                        <span>{{ result.facility_count }} senior living facilities</span>
                                    </div>
                                </div>
                            </div>
                            <div class="result-action">
                                <a href="/city/{{ result.slug }}/" class="view-details">View Details</a>
                            </div>
                        </div>
                        {% elif result.type == 'facility' %}
                        <div class="result-card facility-result">
                            <div class="result-content">
                                <h3 class="result-title">
                                    <a href="/city/{{ result.city_slug }}/#facility-{{ result.id }}">{{ result.name }}</a>
                                </h3>
                                <div class="result-meta">
                                    <span class="result-type">Facility</span>
                                    <span class="result-location">{{ result.city }}, {{ result.state }}</span>
                                    <span class="result-rating">
                                        Rating: {{ result.rating }}/5
                                        <span class="rating-stars">
                                            {% for i in range(5) %}
                                                {% if i < result.rating|int %}
                                                    ★
                                                {% elif i < (result.rating + 0.5)|int %}
                                                    ★
                                                {% else %}
                                                    ☆
                                                {% endif %}
                                            {% endfor %}
                                        </span>
                                    </span>
                                </div>
                                <div class="result-details">
                                    <div class="result-care-types">
                                        <span>Care Types: {{ result.care_types|join(', ') }}</span>
                                    </div>
                                    <div class="result-address">
                                        <span>{{ result.address }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="result-action">
                                <a href="/city/{{ result.city_slug }}/#facility-{{ result.id }}" class="view-details">View Details</a>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="tab-content hidden" id="cities">
                {% set city_results = results|selectattr('type', 'equalto', 'city')|list %}
                {% if city_results|length == 0 %}
                <div class="no-results">
                    <p>No city results found for your search criteria.</p>
                </div>
                {% else %}
                    {% for result in city_results %}
                    <div class="result-card city-result">
                        <div class="result-content">
                            <h3 class="result-title">
                                <a href="/city/{{ result.slug }}/">{{ result.name }}, {{ result.state }}</a>
                            </h3>
                            <div class="result-meta">
                                <span class="result-population">Population: {{ "{:,}".format(result.population) }}</span>
                            </div>
                            <div class="result-details">
                                <div class="result-costs">
                                    <span>Assisted Living: ${{ "{:,}".format(result.assisted_living_cost) }}/month</span>
                                    <span>Memory Care: ${{ "{:,}".format(result.memory_care_cost) }}/month</span>
                                </div>
                                <div class="result-facilities">
                                    <span>{{ result.facility_count }} senior living facilities</span>
                                </div>
                            </div>
                        </div>
                        <div class="result-action">
                            <a href="/city/{{ result.slug }}/" class="view-details">View Details</a>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="tab-content hidden" id="facilities">
                {% set facility_results = results|selectattr('type', 'equalto', 'facility')|list %}
                {% if facility_results|length == 0 %}
                <div class="no-results">
                    <p>No facility results found for your search criteria.</p>
                </div>
                {% else %}
                    {% for result in facility_results %}
                    <div class="result-card facility-result">
                        <div class="result-content">
                            <h3 class="result-title">
                                <a href="/city/{{ result.city_slug }}/#facility-{{ result.id }}">{{ result.name }}</a>
                            </h3>
                            <div class="result-meta">
                                <span class="result-location">{{ result.city }}, {{ result.state }}</span>
                                <span class="result-rating">
                                    Rating: {{ result.rating }}/5
                                    <span class="rating-stars">
                                        {% for i in range(5) %}
                                            {% if i < result.rating|int %}
                                                ★
                                            {% elif i < (result.rating + 0.5)|int %}
                                                ★
                                            {% else %}
                                                ☆
                                            {% endif %}
                                        {% endfor %}
                                    </span>
                                </span>
                            </div>
                            <div class="result-details">
                                <div class="result-care-types">
                                    <span>Care Types: {{ result.care_types|join(', ') }}</span>
                                </div>
                                <div class="result-address">
                                    <span>{{ result.address }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="result-action">
                            <a href="/city/{{ result.city_slug }}/#facility-{{ result.id }}" class="view-details">View Details</a>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        
        {% if page_count > 1 %}
        <div class="pagination">
            {% if current_page > 1 %}
            <a href="{{ pagination_url(current_page - 1) }}" class="page-link prev">Previous</a>
            {% endif %}
            
            {% for p in range(1, page_count + 1) %}
                {% if p == current_page %}
                <span class="page-link current">{{ p }}</span>
                {% elif p <= 3 or p >= page_count - 2 or (p >= current_page - 1 and p <= current_page + 1) %}
                <a href="{{ pagination_url(p) }}" class="page-link">{{ p }}</a>
                {% elif p == 4 and current_page > 5 or p == page_count - 3 and current_page < page_count - 4 %}
                <span class="page-ellipsis">...</span>
                {% endif %}
            {% endfor %}
            
            {% if current_page < page_count %}
            <a href="{{ pagination_url(current_page + 1) }}" class="page-link next">Next</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="/js/search.js"></script>
{% endblock %}
